// ==UserScript==
// @name         phpBBForumAutosaver
// @namespace    http://tampermonkey.net/
// @version      0.0.3
// @description  Autosaving drafts of posts and PMs on phpBB forums in local storage.
// @author       CelularBat
// @homepage     https://github.com/CelularBat/phpBBForumAutosaver
// @match        *://*/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant              GM_getValue
// @grant              GM_setValue
// @grant              GM.getValue
// @grant              GM.setValue
// @grant              GM_registerMenuCommand
// @grant              GM.registerMenuCommand
// ==/UserScript==

(function() {
    (function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function o(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(a){if(a.ep)return;a.ep=!0;const r=o(a);fetch(a.href,r)}})();const g=function(){var e={},t,o=typeof GM_getValue<"u"&&typeof GM_setValue<"u",n=!o&&typeof GM<"u";async function a(l,s){if(t=s,e=l,typeof GM_registerMenuCommand<"u"&&GM.registerMenuCommand("Settings",function(){g.showSettingsWindow()}),n&&typeof GM_registerMenuCommand<"u"&&GM_registerMenuCommand("Settings",function(){g.showSettingsWindow()}),o&&Object.keys(e).forEach(i=>{e[i].value=GM_getValue(i,e[i].default)}),n)for(let i of Object.keys(e))e[i].value=await GM.getValue(i,e[i].default)}function r(){const l=document.createElement("div");l.className="userscript-settings-modal-window";const s=document.createElement("span");s.className="userscript-settings-modal-close",s.innerHTML="&times;",s.onclick=()=>document.body.removeChild(l),l.appendChild(s);const i=document.createElement("table");i.className="userscript-settings-modal-table";const b=document.createElement("tr");b.innerHTML="<th>Setting</th><th>Value</th>",i.appendChild(b),Object.keys(e).forEach(p=>{const v=document.createElement("tr"),h=document.createElement("td");h.className="userscript-settings-tooltip-cell",h.setAttribute("data-tooltip",e[p].description),h.textContent=e[p].label,v.appendChild(h);const E=document.createElement("td");if(typeof e[p].value=="boolean"){const d=document.createElement("input");d.type="checkbox",d.checked=e[p].value,d.onchange=()=>g.update(p,d.checked),E.appendChild(d)}else{const d=document.createElement("input");d.type="number",d.value=e[p].value,d.onchange=()=>g.update(p,Number(d.value)),E.appendChild(d)}v.appendChild(E),i.appendChild(v)}),l.appendChild(i),document.body.appendChild(l)}function u(l,s){e[l].value=s,o&&GM_setValue(l,s),n&&(async()=>await GM.setValue(l,s))(),t(l,s)}function m(){Object.keys(e).forEach(l=>{g.update(l,e[l].default)})}return{init:a,showSettingsWindow:r,update:u,restoreDefault:m}}();/**
 * @license lucide v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"};/**
 * @license lucide v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=([e,t,o])=>{const n=document.createElementNS("http://www.w3.org/2000/svg",e);return Object.keys(t).forEach(a=>{n.setAttribute(a,String(t[a]))}),o!=null&&o.length&&o.forEach(a=>{const r=B(a);n.appendChild(r)}),n},x=(e,t={})=>{const o="svg",n={...T,...t};return B([o,n,e])};/**
 * @license lucide v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17"}]];/**
 * @license lucide v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}],["path",{d:"M3 3v5h5"}]];/**
 * @license lucide v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7"}]];/**
 * @license lucide v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}],["circle",{cx:"12",cy:"12",r:"3"}]];/**
 * @license lucide v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=[["path",{d:"M3 6h18"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17"}]],A={ALLOW_DEBUG:{description:"Allow debug messages in the console",label:"Enable Debugging",value:!0,default:!0},AUTOSAVE_SECONDS_DELAY:{description:"Seconds between autosaving the current copy",label:"Autosave Delay (seconds)",value:30,default:30},AUTOARCHIVE_MINUTES_DELAY:{description:"Minutes between archiving copies",label:"Auto-Archive Delay (minutes)",value:1,default:1},MAX_ARCHIVED:{description:"Maximum number of archived copies before older ones are removed",label:"Max Archived Copies",value:30,default:30},PLACE_NEAR_TEXTAREA:{description:"Whether to place the panel near the textarea or in the window corner",label:"Place Panel Near Textarea",value:!0,default:!0}},c=document.querySelector("textarea#message")||document.querySelector('textarea[name="message"]');var C,f,_,S,y=[];function F(){if(g.init(A,R),!c)return A.ALLOW_DEBUG.value&&console.warn("phpBBForumAutosaver:","No textareas with proper ID found on that page"),0;let e=G();if(e)f="PhpBBForumAutosaver-"+e+"_old",C="PhpBBForumAutosaver-"+e+"_current";else return 0;U(c),H(),_=setInterval(()=>{M()},A.AUTOSAVE_SECONDS_DELAY.value*1e3),S=setInterval(()=>{L()},A.AUTOARCHIVE_MINUTES_DELAY.value*1e3*60)}function R(e,t){e==="AUTOSAVE_SECONDS_DELAY"&&(clearInterval(_),_=setInterval(()=>{M()},t*1e3)),e==="AUTOARCHIVE_MINUTES_DELAY"&&(clearInterval(S),S=setInterval(()=>{L()},t*1e3*60))}function G(){const e=new URL(window.location.href);if(e.hostname==="localhost"||e.hostname==="127.0.0.1")return"localhost_devTest";let t=e.searchParams.get("t");if(!t){const n=/\/[^,]+,(\d+)\.html$/,a=e.pathname.match(n);a&&(t=a[1])}if(t)return`topicReply_${t}`;const o=e.searchParams.get("mode");if(!o)return console.warn("phpBBForumAutosaver:","Textarea found, but can't create ID for this url"),0;if(o==="post")return`newTopicOnSubforum_${e.searchParams.get("f")}`;if(o==="compose"){let n=e.searchParams.get("p");return n?`ReplyPM_${n}`:"NewPM"}return console.warn("phpBBForumAutosaver:","Textarea found, but can't create ID for this url, unknown mode"),0}function U(e){const t=document.createElement("div");if(t.id="PhpBBForumAutosaver_Panel",[{icon:P,tooltip:"Manually save post",name:"save",onClick:$},{icon:O,tooltip:"Load last saved post",name:"loadLast",onClick:k},{icon:N,tooltip:"Load copy - choose from saved versions",name:"loadAny",onClick:Y},{icon:I,tooltip:"Delete all saved copies for this draft",name:"delete",onClick:j,spacing:!0},{icon:V,tooltip:"Settings",name:"settings",onClick:W,spacing:!0}].forEach(({icon:n,tooltip:a,name:r,onClick:u,spacing:m})=>{const l=document.createElement("div");l.className="icon-btn",l.id=`btn_${r}`,l.setAttribute("data-tooltip",a),l.onclick=u,m&&(l.style.marginTop="20px");const s=x(n);l.appendChild(s),t.appendChild(l),y.push(l)}),A.PLACE_NEAR_TEXTAREA.value===!0){let n=e.getBoundingClientRect();t.style.left=`${n.left+window.scrollX-30}px`,t.style.top=`${n.top+window.scrollY+100}px`,t.style.position="absolute"}else t.style.left="20px",t.style.top="8rem",t.style.position="fixed";return document.body.appendChild(t),t}function H(){let e=localStorage.getItem(C),t=JSON.parse(localStorage.getItem(f));c.value===""&&(e?c.value=e:t&&(c.value=t.archived.at(-1).text))}function L(){let e=y.find(r=>r.id==="btn_loadAny");if(c.value===""||c.value.length<10)return;let t=JSON.parse(localStorage.getItem(f)),o;if(t){if(t.archived.length>0&&t.archived.at(-1).text===c.value){w(e,"yellow",2e3);return}o=t.archived,o.length>=A.MAX_ARCHIVED.value&&o.shift()}else o=[];let n=new Date;o.push({date:n,text:c.value});let a={lastArchived:n,archived:o};localStorage.setItem(f,JSON.stringify(a)),w(e,"green",5e3)}function M(){if(c.value===""||c.value.length<10)return;localStorage.setItem(C,c.value);let e=y.find(t=>t.id==="btn_save");w(e,"green",2e3)}function $(){M()}function k(){let e=localStorage.getItem(C),t=y.find(o=>o.id==="btn_loadLast");e?(c.value=e,w(t,"green",3e3)):(w(t,"red",2e3),console.warn("PhpBBForumAutosaver:","no saved draft yet"))}function W(){g.showSettingsWindow()}function Y(){let e=JSON.parse(localStorage.getItem(f));e&&e.archived&&D(e.archived)}function j(){confirm("Do you really want to DELETE all drafts for this page?")&&(localStorage.removeItem(C),localStorage.removeItem(f),alert("All drafts deleted."))}function w(e,t,o){let n=e.style.color;e.style.color=t,setTimeout(()=>{e.style.color=n},o)}function D(e){const t=document.createElement("div");t.className="modal-window";const o=document.createElement("div");o.className="modal-close",o.innerHTML="&times;",o.onclick=()=>document.body.removeChild(t),t.appendChild(o);const n=document.createElement("div");n.className="modal-table-container",e.length>7&&(n.style.maxHeight="300px",n.style.overflowY="auto");const a=document.createElement("table");a.className="modal-table";const r=a.createTHead().insertRow();["Date","Text","Action","Delete"].forEach(m=>{const l=document.createElement("th");l.textContent=m,r.appendChild(l)});const u=a.createTBody();e.forEach(({date:m,text:l},s)=>{const i=u.insertRow();i.insertCell().textContent=new Date(m).toLocaleString();const b=l.split(`
`)[0]||"",p=l.split(`
`).slice(-1)[0]||"";i.insertCell().textContent=`${b} (...) ${p}`;const v=document.createElement("button");v.textContent="Load",v.onclick=()=>{c.value=l,document.body.removeChild(t)},i.insertCell().appendChild(v);const h=document.createElement("button"),E=x(I);h.appendChild(E),h.onclick=()=>{confirm("Do you really want to DELETE this version?")&&(document.body.removeChild(t),J(m))},i.insertCell().appendChild(h)}),n.appendChild(a),t.appendChild(n),document.body.appendChild(t)}function J(e){let t=JSON.parse(localStorage.getItem(f)),o=t.archived.findIndex(n=>n.date===e);o!==-1?(t.archived.splice(o,1),localStorage.setItem(f,JSON.stringify(t))):console.warn("PhpBBForumAutosaver:","cant delete archived copy, something went wrong"),D(t.archived)}function X(){const e=new URL(window.location.href);return e.searchParams.get("mode")||e.includes("viewtopic")}X()&&F();


/* Injected CSS */
const styleToInject = document.createElement('style');
        styleToInject.textContent = `#PhpBBForumAutosaver_Panel{transform:translateY(-50%);width:20px;background:#333;display:flex;flex-direction:column;gap:13px;padding:5px 2px;border-radius:3px}.icon-btn{width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;position:relative}.icon-btn img{width:16px;height:16px}.icon-btn:hover{background:#fff3;border-radius:3px}.icon-btn:after{content:attr(data-tooltip);position:absolute;left:25px;background:#000;color:#fff;padding:5px;font-size:12px;white-space:nowrap;border-radius:3px;opacity:0;transition:opacity .2s;pointer-events:none}.icon-btn:hover:after{opacity:1}.modal-window{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;color:#fff;padding:15px;border-radius:5px;box-shadow:0 0 10px #00000080;z-index:1000;min-width:300px}.modal-close{position:absolute;top:5px;right:10px;cursor:pointer;font-size:18px;color:#fff}.modal-close:hover{color:red}.modal-table{width:100%;border-collapse:collapse;margin-top:10px}.modal-table th,.modal-table td{border:1px solid #444;padding:8px;text-align:left}.modal-table th{background:#333}.modal-table button{background:#555;color:#fff;border:none;padding:5px 10px;cursor:pointer;border-radius:3px}.modal-table button:hover{background:#777}.userscript-settings-modal-window{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;color:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 10px #0000004d;z-index:1000;max-width:80%;max-height:80%;overflow:auto}.userscript-settings-modal-close{position:absolute;top:5px;right:10px;cursor:pointer;font-size:24px;color:#fff}.userscript-settings-modal-table{width:100%;border-collapse:collapse}.userscript-settings-modal-table th,.userscript-settings-modal-table td{padding:10px;border:1px solid #555;text-align:left}.userscript-settings-modal-table th{background:#333;color:#fff}.userscript-settings-tooltip-cell{position:relative;cursor:help}.userscript-settings-tooltip-cell:after{content:attr(data-tooltip);position:absolute;left:50%;bottom:100%;background:#000;color:#fff;padding:5px;font-size:12px;white-space:nowrap;border-radius:3px;opacity:0;transition:opacity .2s;transform:translate(-50%);pointer-events:none}.userscript-settings-tooltip-cell:hover:after{opacity:1}
`;
        document.head.appendChild(styleToInject);
})();